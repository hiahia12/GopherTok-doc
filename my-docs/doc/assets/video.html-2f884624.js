import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as l,o as r,c as o,a,b as t,e as n,d}from"./app-c6e67914.js";const s={},h=d('<h1 id="video" tabindex="-1"><a class="header-anchor" href="#video" aria-hidden="true">#</a> video</h1><h2 id="发布视频" tabindex="-1"><a class="header-anchor" href="#发布视频" aria-hidden="true">#</a> 发布视频</h2><blockquote><p>支持三种方式存储，minio集群，腾讯云cos，本地，可通过nacos配置</p></blockquote><h3 id="流程" tabindex="-1"><a class="header-anchor" href="#流程" aria-hidden="true">#</a> 流程</h3><ol><li>首先计算出视频的sha256值，在redis中查询是否存在该值，若存在说明之前用户传过一样的视频，则直接从redis查询视频的url和封面的url,返回上传成功</li><li>将计算出的sha256存入redis中</li><li>拼接好文件路径</li><li>使用ffmpeg截取视频第一帧作为封面</li><li>根据三种存储方式对应上传，并生成相应的url</li><li>利用雪花算法生成id，带上视频的基本信息写入kafka中</li><li>返回视频上传成功</li><li>kafka消费数据，写入mysql和redis</li></ol><h2 id="查看用户发布的全部视频" tabindex="-1"><a class="header-anchor" href="#查看用户发布的全部视频" aria-hidden="true">#</a> 查看用户发布的全部视频</h2><ol><li>根据user_id从mysql中查询全部视频</li><li>并发调用其他rpc拼接最终返回信息</li></ol><h2 id="视频流" tabindex="-1"><a class="header-anchor" href="#视频流" aria-hidden="true">#</a> 视频流</h2><ol><li>根据latest_time从mysql查询30个视频</li><li>并发调用其他rpc拼接最终返回信息</li></ol><h2 id="mq" tabindex="-1"><a class="header-anchor" href="#mq" aria-hidden="true">#</a> mq</h2><ul><li>kafka聚集写入</li></ul><figure><img src="https://raw.githubusercontent.com/liuxianloveqiqi/Xian-imagehost/main/image/image-20230708153904061.png" alt="image-20230708153904061" tabindex="0" loading="lazy"><figcaption>image-20230708153904061</figcaption></figure><p>之前每向kafka发送一条消息就会产生一次网络 IO 和一次磁盘 IO，做消息聚合后，比如聚合 100 条消息后再发送给 Kafka，这个时候 100 条消息才会产生一次网络 IO 和磁盘 IO，这样大大提高 Kafka 的吞吐和性能。并且有聚合时间兜底，就算消息数量达不到聚合要求，超过聚合最大时间也会聚合当前所有消息发送给Kafka</p><ul><li>并发消费</li></ul><figure><img src="https://cdn.learnku.com/uploads/images/202207/15/73865/pBHJlrB3rC.webp!large" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>通过多个 goroutine 来并行的消费数据</p><h2 id="亮点" tabindex="-1"><a class="header-anchor" href="#亮点" aria-hidden="true">#</a> 亮点</h2><ul><li>计算视频的sha256值可以做到秒传视频</li><li>利用ffmpeg截取视频第一帧作为封面</li><li>可以选择三种存储方式｜腾讯云cos|minio集群｜本地</li><li>kafka异步写入视频信息已经相关优化</li><li>并发调用其他服务rpc拼接返回信息</li><li>并发写入数据库</li></ul><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h2>',19),c={href:"https://learnku.com/articles/69754",target:"_blank",rel:"noopener noreferrer"};function f(u,m){const i=l("ExternalLinkIcon");return r(),o("div",null,[h,a("p",null,[a("a",c,[t("https://learnku.com/articles/69754"),n(i)])])])}const k=e(s,[["render",f],["__file","video.html.vue"]]);export{k as default};
